<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Server Side Part III - Logic - (Full Stack Strawpoll) | Project Based Learning</title>
  <meta name="author" content="Thomas Ulrich">
  
  <meta name="description" content="A simple blog to illustrate my interests in programming, television, nature, and anything else">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Server Side Part III - Logic - (Full Stack Strawpoll)"/>
  <meta property="og:site_name" content="Project Based Learning"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Project Based Learning" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Project Based Learning</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-25T20:16:10.000Z"><a href="/2017/02/25/FSS-Server-Side-3/">2017-02-25</a></time>
      
      
  
    <h1 class="title">Server Side Part III - Logic - (Full Stack Strawpoll)</h1>
  

    </header>
    <div class="entry">
      
        <p>Alright, we’ll finally finish the server side of the Strawpoll service now!  I swear we’ll be done after this one.  There has been a lot of setup, but most good projects take a fair amount of setup, then everything becomes simple.  To finish this service, all we have to do still are setup the logic in each of our routes, so we’ll go through them one at a time<br><a id="more"></a></p>
<h2 id="Creating-a-New-Poll"><a href="#Creating-a-New-Poll" class="headerlink" title="Creating a New Poll"></a>Creating a New Poll</h2><p>When building up an API, it is sometimes helpful to start with routes that will provide the data that other routes used, otherwise you will be forced to mock data to do any testing as you go.  Since we need a poll before we can get a poll or modify a poll, it makes sense to try to build this logic up before the other ones.  I’ll spend a bit more time talking about this first route than the others to explain what is going on, so stay with me.  </p>
<p>As a referesher of our Poll model, here is the relevant snippet of code from poll.js.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> pollSchema = <span class="keyword">new</span> Schema(&#123;</div><div class="line">  <span class="attr">poll_name</span>: <span class="built_in">String</span>,</div><div class="line">  <span class="attr">poll_options</span>: [&#123; <span class="attr">option_name</span>: <span class="built_in">String</span>, <span class="attr">vote_count</span>: <span class="built_in">Number</span> &#125;],</div><div class="line">  <span class="attr">poll_votes</span>: <span class="built_in">Number</span>,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>So, this is the information that we will need to provide to the model to successfully create a poll.  Now, you may have wondered what the ‘bodyParser’ that we included in the last post was about, but what it does is allow us to read data sent to the API via the request object. Let’s change our create a poll logic to something like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CREATE A POLL ---------------------------------------------------------------</span></div><div class="line">app.post(<span class="string">'/api/poll'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(req.body &amp;&amp; req.body.poll_name &amp;&amp; req.body.poll_options)&#123;</div><div class="line">    <span class="keyword">var</span> newPoll = <span class="keyword">new</span> Poll();</div><div class="line">    newPoll.poll_name = req.body.poll_name;</div><div class="line">    newPoll.poll_options = req.body.poll_options;</div><div class="line">    newPoll.poll_votes = <span class="number">0</span>;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    res.json(&#123;</div><div class="line">      <span class="attr">success</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">message</span>: <span class="string">"Missing poll name or options"</span>,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>So what did we do here?  We are checking a few things in the if statement:</p>
<ul>
<li>Is there any information in the body of the request?  If not, the if statement fails due to short circuit evaluation and will fall into the else block.  We don’t want to look for something in the body of the request if the body doesn’t exist, because that will always be bad news bears and throw errors</li>
<li>Is there a poll name?  This is going to be a required attribute for making a poll</li>
<li>Are there any options associate with the poll?  There should be.</li>
</ul>
<p>If all of these things are true, we set the information in the MODEL to the data that came from the REQUEST.  If anything is missing, we send a response in json format regarding the failure.  There is still more to add here though; we haven’t sent a response for the success yet.  If somebody tried to post to this route now with all the appropriate information, the server would just ‘hang’ and never respond to the client.  </p>
<p>To remedy this, let’s modify the route a bit further, and actually save the data to the database using the Mongoose model method, save, and then respond back to the client whether it was successfully saved or not.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CREATE A POLL ---------------------------------------------------------------</span></div><div class="line">app.post(<span class="string">'/api/poll'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(req.body &amp;&amp; req.body.poll_name &amp;&amp; req.body.poll_options)&#123;</div><div class="line">    <span class="keyword">var</span> newPoll = <span class="keyword">new</span> Poll();</div><div class="line">    newPoll.poll_name = req.body.poll_name;</div><div class="line">    newPoll.poll_options = req.body.poll_options;</div><div class="line">    newPoll.poll_votes = <span class="number">0</span>;</div><div class="line">    newPoll.save(<span class="function"><span class="keyword">function</span>(<span class="params">err,poll</span>)</span>&#123;</div><div class="line">      <span class="keyword">if</span>(err)&#123;</div><div class="line">        res.json(&#123;</div><div class="line">          <span class="attr">success</span>: <span class="literal">false</span>,</div><div class="line">          <span class="attr">message</span>: <span class="string">"Error saving poll information"</span>,</div><div class="line">        &#125;);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        res.json(&#123;</div><div class="line">          <span class="attr">success</span>: <span class="literal">true</span>,</div><div class="line">          <span class="attr">message</span>: <span class="string">"Successfully created poll"</span>,</div><div class="line">          <span class="attr">data</span>: poll,</div><div class="line">        &#125;);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    res.json(&#123;</div><div class="line">      <span class="attr">success</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">message</span>: <span class="string">"Missing poll name or options"</span>,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Now we have a fully formed route to handle the poll creation.  However, I feel like this looks pretty messy and is starting to get garbled.  There is a lot of nested information here that becomes difficult to understand in a glance already, so I see an obvious step to clean this up and refactor.  Refactoring code as you go is important, and if you ever see a scenario where you can move thing to a single method, take it.  </p>
<p>Here, I see that the responses all have pretty similar formats, so I’m going to pull these out into separate functions, and we’ll end up with the following code.  Refactors like this can be tricky, because usually they are quite helpful, but every time you introduce a new function into the mix, it is something else that you have to just keep in memory.  So, try to keep functions simple, and keep their names useful to their purpose, so you can ‘assume’ the function is acting correctly and read the logic.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HELPERS ---------------------------------------------------------------------</span></div><div class="line"><span class="keyword">var</span> errorResponse = <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">success</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">message</span>: msg,</div><div class="line">  &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> successResponse = <span class="function"><span class="keyword">function</span>(<span class="params">msg, data</span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">success</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">message</span>: msg,</div><div class="line">    <span class="attr">data</span>: data,</div><div class="line">  &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// CREATE A POLL ---------------------------------------------------------------</span></div><div class="line">app.post(<span class="string">'/api/poll'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(req.body &amp;&amp; req.body.poll_name &amp;&amp; req.body.poll_options)&#123;</div><div class="line">    <span class="keyword">var</span> newPoll = <span class="keyword">new</span> Poll();</div><div class="line">    newPoll.poll_name = req.body.poll_name;</div><div class="line">    newPoll.poll_options = req.body.poll_options;</div><div class="line">    newPoll.poll_votes = <span class="number">0</span>;</div><div class="line">    newPoll.save(<span class="function"><span class="keyword">function</span>(<span class="params">err,poll</span>)</span>&#123;</div><div class="line">      <span class="keyword">if</span>(err)&#123;</div><div class="line">        res.json(errorResponse(<span class="string">"Error saving poll information"</span>));</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        res.json(successResponse(<span class="string">"Successfully created poll"</span>, poll));</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    res.json(errorResponse(<span class="string">"Missing poll name or options"</span>));</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>COOL! We’ve got something that <strong>should</strong> work, so let’s try it out, right?  Fire up Postman, and try making a request to this route endpoint by posting data.<br><img src="/2017/02/25/FSS-Server-Side-3/Postman-REQ.png" alt="Postman Request/Response}</p>" title="Postman Request/Response}</p>"></p>
      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/Project-Full-Stack-Strawpoll/">(Project) Full Stack Strawpoll</a>, <a href="/tags/Node-js/">Node.js</a>, <a href="/tags/Express/">Express</a>, <a href="/tags/MongoDB/">MongoDB</a>, <a href="/tags/Javascript/">Javascript</a>, <a href="/tags/Mongoose/">Mongoose</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:localhost:4000">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Projects/">Projects</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Projects/Intermediate/">Intermediate</a><span class="category-list-count">1</span></li></ul></li></ul>
  </ul>
</div>



  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Project-Full-Stack-Strawpoll/">(Project) Full Stack Strawpoll</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Express/">Express</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JQuery/">JQuery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/">Javascript</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mongoose/">Mongoose</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js/">Node.js</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Postman/">Postman</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Project-Structures/">Project Structures</a><span class="tag-list-count">1</span></li></ul>
  </ul>
</div>


</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 Thomas Ulrich
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'faykade';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
